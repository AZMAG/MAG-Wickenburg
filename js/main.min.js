/*!
*@main.min.js
*@JavaScript document for Wickenburg Zoning Map Viewer @ MAG
*@For Production
*@Wickenburg-Project - v3.5.0 | 03-05-2015
*@author Vern Wolfley
*/

function toggleContent(){$("#legend").is(":hidden")?($("#legend").slideDown(),$("#legend").draggable({containment:"#mapDiv"}),$("#contentsOpen")):($("#legend").slideUp(),$("#contentsOpen"))}function toggleMTool(){$("#mTool").is(":hidden")?($("#mTool").slideDown(),$("#mTool").draggable({containment:"#mapDiv"}),$("#measureOpen")):($("#mTool").slideUp(),$("#measureOpen"))}function togglePrint(){$("#printTool").is(":hidden")?($("#printTool").slideDown(),$("#printTool").draggable({containment:"#mapDiv"}),$("#printOpen")):($("#printTool").slideUp(),$("#printOpen"))}require(["dojo/dom-construct","dojo/dom","dojo/on","dojo/parser","dojo/query","dojo/keys","esri/sniff","esri/map","esri/SnappingManager","esri/dijit/Measurement","esri/dijit/Scalebar","esri/dijit/HomeButton","esri/dijit/LocateButton","esri/dijit/Geocoder","esri/graphic","esri/geometry/Multipoint","esri/symbols/PictureMarkerSymbol","esri/symbols/SimpleFillSymbol","esri/symbols/SimpleLineSymbol","esri/tasks/IdentifyTask","esri/tasks/IdentifyParameters","esri/dijit/Popup","dojo/_base/array","dojo/_base/Color","esri/layers/ArcGISDynamicMapServiceLayer","esri/layers/ImageParameters","esri/dijit/Legend","dijit/form/CheckBox","dijit/form/HorizontalSlider","dijit/form/HorizontalRule","dijit/form/HorizontalRuleLabels","js/vendor/bootstrapmap.min.js","esri/dijit/BasemapToggle","esri/layers/FeatureLayer","esri/dijit/PopupTemplate","esri/InfoTemplate","esri/symbols/SimpleMarkerSymbol","esri/dijit/Print","esri/tasks/PrintTemplate","esri/request","esri/config","dojo/domReady!"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N){function O(a){var c,d,e;return c=w.filter(a.parameters,function(a){return"Layout_Template"===a.name}),0===c.length?void console.log('print service parameters name for templates must be "Layout_Template"'):(d=c[0].choiceList,mapOnlyRemove=w.indexOf(d,"MAP_ONLY"),mapOnlyRemove>-1&&d.splice(mapOnlyRemove,mapOnlyRemove),e=w.map(d,function(a){var b=new M;return b.layout=b.label=a,b.format="PDF",b.layoutOptions={titleText:"Wickenburg Zoning"},b}),printer=new L({map:db,templates:e,url:appConfig.printUrl},b.byId("printButton")),void printer.startup())}function P(a){console.log("Something broke: ",a)}function Q(){var a=this.dojoAttachPoint,b=xb[a].checked;b===!0&&eb.remove(),b!==!0&&(eb=db.on("click",Y))}function R(a){var b=a.graphic?a.graphic:a.result.feature;b.setSymbol(zb),T(a.result,b.symbol)}function S(a){if(a=a.results,a.length>0){V();for(var b=zb,c=0;c<a.length;c++)T(a[c],b);U(a)}else alert("Sorry, address or place not found.")}function T(a,b){var c,d,e,f,g={};e=a.feature.geometry,g.address=a.name,g.score=a.feature.attributes.Score,c={address:g.address,score:g.score,lat:e.getLatitude().toFixed(2),lon:e.getLongitude().toFixed(2)},d=new J("${address}","Latitude: ${lat}<br/>Longitude: ${lon}<br/>Score: ${score}"),f=new o(e,b,c,d),db.graphics.add(f)}function U(a){for(var b=new p(db.spatialReference),c=0;c<a.length;c++)b.addPoint(a[c].feature.geometry);db.setExtent(b.getExtent().expand(2))}function V(){db.infoWindow.hide(),db.graphics.clear()}function W(a,b,c){return new q({angle:0,xoffset:b,yoffset:c,type:"esriPMS",url:a,contentType:"image/png",width:12,height:24})}function X(){identifyTask1=new t(appConfig.mainURL),identifyParamsTask1=new u,identifyParamsTask1.layerIds=[5],identifyParamsTask1.tolerance=3,identifyParamsTask1.returnGeometry=!0,identifyParamsTask1.layerOption=u.LAYER_OPTION_VISIBLE,identifyParamsTask1.width=db.width,identifyParamsTask1.height=db.height,identifyTask2=new t(appConfig.mainURL),identifyParamsTask2=new u,identifyParamsTask2.layerIds=[1],identifyParamsTask2.tolerance=3,identifyParamsTask2.returnGeometry=!0,identifyParamsTask2.layerOption=u.LAYER_OPTION_VISIBLE,identifyParamsTask2.width=db.width,identifyParamsTask2.height=db.height,identifyTask3=new t(appConfig.mainURL),identifyParamsTask3=new u,identifyParamsTask3.layerIds=[4],identifyParamsTask3.tolerance=3,identifyParamsTask3.returnGeometry=!0,identifyParamsTask3.layerOption=u.LAYER_OPTION_VISIBLE,identifyParamsTask3.width=db.width,identifyParamsTask3.height=db.height}function Y(a){for(var b=(db.layerIds,Z),c=0;c<b.length;c++){var d=b[c].layer.visible,e=b[c].id;"wiZoning"===e&&d===!0&&(identifyParamsTask1.layerIds=[5]),"wiZoning"===e&&d===!1&&(identifyParamsTask1.layerIds=[-1]),"tParcels"===e&&d===!0&&(identifyParamsTask2.layerIds=[1]),"tParcels"===e&&d===!1&&(identifyParamsTask2.layerIds=[-1]),"wiFlood"===e&&d===!0&&(identifyParamsTask3.layerIds=[4]),"wiFlood"===e&&d===!1&&(identifyParamsTask3.layerIds=[-1])}identifyParamsTask1.geometry=a.mapPoint,identifyParamsTask1.mapExtent=db.extent,identifyParamsTask2.geometry=a.mapPoint,identifyParamsTask2.mapExtent=db.extent,identifyParamsTask3.geometry=a.mapPoint,identifyParamsTask3.mapExtent=db.extent;var f=identifyTask1.execute(identifyParamsTask1).addCallback(function(a){return w.map(a,function(a){var b=a.feature;if(b.attributes.layerName=a.layerName,0!==b.attributes.OBJECTID){var c=new J;c.setTitle("Wickenburg Zoning"),c.setContent("Zoning Code: ${CODE}<br>Zoning Description: ${Description}"),b.setInfoTemplate(c)}return b})}),g=identifyTask2.execute(identifyParamsTask2).addCallback(function(a){return w.map(a,function(a){var b=a.feature;if(b.attributes.layerName=a.layerName,0!==b.attributes.OBJECTID){var c=new J;c.setTitle("County Parcels"),c.setContent("County: ${COUNTY}<br>Parcel: ${PARCEL_LABEL}<br>Address: ${PHYSICAL_ADDRESS}"),b.setInfoTemplate(c)}return b})}),h=identifyTask3.execute(identifyParamsTask3).addCallback(function(a){return w.map(a,function(a){var b=a.feature;if(b.attributes.layerName=a.layerName,0!==b.attributes.OBJECTID){var c=new J;c.setTitle("Flood Zone"),c.setContent("Flood Zone: ${ZONE}"),b.setInfoTemplate(c)}return b})});db.infoWindow.setFeatures([f,g,h]),db.infoWindow.show(a.mapPoint)}d.parse(),esri.config.defaults.io.proxyUrl="proxy/proxy.ashx",esri.config.defaults.io.alwaysUseProxy=!1,b.byId("version").innerHTML=appConfig.Version;var Z=[],$=[],_=new r(r.STYLE_SOLID,new s(s.STYLE_SOLID,new x([0,128,255]),3),null),ab=new r(r.STYLE_BACKWARD_DIAGONAL,new s(s.STYLE_SOLID,new x([0,255,255]),2),new x([0,255,255,.25])),bb=new K("circle",26,null,new x([0,0,0,.25])),cb=new v({fillSymbol:ab,markerSymbol:bb},a.create("div")),db=F.create("mapDiv",{extent:new esri.geometry.Extent(appConfig.initExtent),basemap:"streets",minZoom:9,maxZoom:19,showAttribution:!1,logo:!1,infoWindow:cb,sliderPosition:"top-right",scrollWheelZoom:!0});db.on("load",X);var eb=db.on("click",Y);db.on("unload",Y);var fb=(new k({map:db,scalebarUnit:"english"}),new l({map:db,visible:!0},a.create("div",{id:"HomeButton"},"mapDiv","last")));fb._homeNode.title="Original Extent",fb.startup();var gb=new m({map:db,visible:!0},a.create("div",{id:"LocateButton"},"mapDiv","last"));gb.startup();var hb=new G({map:db,visible:!0,basemap:"satellite"},a.create("div",{id:"BasemapToggle"},"mapDiv","last"));hb.startup();var ib=new n({value:"",zoomScale:10,maxLocations:10,autoComplete:!0,arcgisGeocoder:{sourceCountry:"USA",placeholder:"155 N Tegner St, Wickenburg, AZ"},map:db},"geosearch");ib.startup(),ib.on("select",R),ib.on("findResults",S),ib.on("clear",V);var jb=N({url:appConfig.printUrl,content:{f:"json"}});jb.then(O,P);var kb=new z;kb.layerIds=[5],kb.layerOption=z.LAYER_OPTION_SHOW;var lb=db.addLayer(new y(appConfig.mainURL,{id:"wiZoning",imageParameters:kb,outFields:["*"],visible:!0,opacity:.65})),mb=new z;mb.layerIds=[4],mb.layerOption=z.LAYER_OPTION_SHOW;var nb=db.addLayer(new y(appConfig.mainURL,{id:"wiFlood",imageParameters:mb,outFields:["*"],visible:!1,opacity:.65})),ob=new z;ob.layerIds=[1],ob.layerOption=z.LAYER_OPTION_SHOW;var pb=db.addLayer(new y(appConfig.mainURL,{id:"tParcels",imageParameters:ob,outFields:["*"],visible:!1,opacity:1})),qb=db.addLayer(new H(appConfig.mainURL+"/3",{id:"coBoundary",mode:H.MODE_ONDEMAND,visible:!0,opacity:1})),rb=db.addLayer(new H(appConfig.mainURL+"/2",{id:"wiBoundary",mode:H.MODE_ONDEMAND,visible:!0,opacity:1})),sb="<strong>${EMPNAME}</strong><hr class='pLine'>${ADDRESS}</br>${CITY}, ${STATE} ${ZIP}<br>Type:  ${CLUSTER}",tb=new J("Employers",sb),ub=db.addLayer(new H(appConfig.mainURL+"/0",{id:"wiEmployers",visible:!1,opacity:1,mode:H.MODE_ONDEMAND,infoTemplate:tb,outFields:["*"]})),vb=db.enableSnapping({snapKey:g("mac")?f.META:f.CTRL}),wb=[{layer:pb}];vb.setLayerInfos(wb);var xb=new j({map:db,lineSymbol:_},b.byId("measurementDiv"));xb.startup(),c(xb.area,"click",Q),c(xb.distance,"click",Q),c(xb.location,"click",Q),Z.push({layer:pb,id:"tParcels",title:"Wickenburg Parcels"}),Z.push({layer:rb,id:"wiBoundary",title:"Wickenburg Boundary"}),Z.push({layer:nb,id:"wiFlood",title:"Wickenburg Flood Zone"}),Z.push({layer:lb,id:"wiZoning",title:"Wickenburg Zoning"}),Z.push({layer:ub,id:"wiEmployers",title:"Wickenburg Employers, 5+ employees"}),$.push({layer:pb,id:"tParcels",title:"Wickenburg Parcels"}),$.push({layer:qb,id:"coBoundary",title:"Maricopa County Boundary"}),$.push({layer:rb,id:"wiBoundary",title:"Wickenburg Town Boundary"}),$.push({layer:nb,id:"wiFlood",title:"Wickenburg Flood Zone"}),$.push({layer:lb,id:"wiZoning",title:"Wickenburg Zoning"});var yb=new A({map:db,layerInfos:$},"legendDiv");yb.startup(),w.forEach(Z,function(c){var d=c.title,e=new B({name:"checkBox"+c.layer.id,value:c.layer.id,checked:c.layer.visible,onChange:function(){var a=db.getLayer(this.value);a.setVisibility(!a.visible),this.checked=a.visible}});a.place(e.domNode,b.byId("toggleDiv"));var f=a.create("label",{"for":e.name,innerHTML:"&nbsp;&nbsp;"+d},e.domNode,"after");a.place("<br>",f,"after")});var zb=(new C({name:"slider1",value:nb.opacity,minimum:0,maximum:1,intermediateChanges:!0,discreteValues:11,style:"width:250px;",onChange:function(a){nb.setOpacity(a)}},"slider1"),new C({name:"slider2",value:lb.opacity,minimum:0,maximum:1,intermediateChanges:!0,discreteValues:11,style:"width:250px;",onChange:function(a){lb.setOpacity(a)}},"slider2"),W("img/blue-pin.png",0,12,35)),Ab=a.create("a",{"class":"action",id:"infoLink",innerHTML:"Assessor Info",href:"javascript: void(0);"},e(".actionList",db.infoWindow.domNode)[0]);c(Ab,"click",function(){var a=db.infoWindow.getSelectedFeature(),b=(window.location,"");"13"===a.attributes.COUNTY_FIPS&&(b=appConfig.MaricopaAssessor+a.attributes.PARCEL,window.open(b)),"25"===a.attributes.COUNTY_FIPS&&(b=appConfig.YavapaiAssessor+a.attributes.PARCEL,window.open(b))})}),$(document).ready(function(){$("#contentsOpen").fadeTo("slow"),$("#legend").fadeTo("slow"),contentsOpen=$("#contentsOpen").height(),$("#legend").css("top",contentsOpen),$("#contentsOpen").click(function(){toggleContent()})}),$(document).ready(function(){$("#measureOpen").fadeTo("slow"),$("#mTool").fadeTo("slow"),measureOpen=$("#measureOpen").height(),$("#mTool").css("top",measureOpen),$("#measureOpen").click(function(){toggleMTool()})}),$(document).ready(function(){$("#mTool").hide()}),$(document).ready(function(){$("#printOpen").fadeTo("slow"),$("#printTool").fadeTo("slow"),printOpen=$("#printOpen").height(),$("#printTool").css("top",printOpen),$("#printOpen").click(function(){togglePrint()})}),$(document).ready(function(){$("#printTool").hide()}),$(document).ready(function(){$("#legend").load("views/contents.html"),$("#helpContent").load("views/helpContent.html"),$("#aboutInfo").load("views/about.html"),$("#legalDisclaimer").load("views/legalDisclaimer.html"),$("#definitions").load("views/definitions.html"),$("#mTool").load("views/measureTool.html"),$("#helpTool").load("views/helpTool.html"),$("#printTool").load("views/printTool.html"),$("#helpPrint").load("views/helpPrint.html")});