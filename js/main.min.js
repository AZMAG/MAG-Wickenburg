/*!
*@main.min.js
*@JavaScript document for Wickenburg Zoning Map Viewer @ MAG
*@For Production
*@Wickenburg-Project - v3.3.0 | 06-30-2014
*@author Vern Wolfley
*/

function toggleContent(){$("#legend").is(":hidden")?($("#legend").slideDown(),$("#legend").draggable({containment:"#mapDiv"}),$("#contentsOpen")):($("#legend").slideUp(),$("#contentsOpen"))}function toggleMTool(){$("#mTool").is(":hidden")?($("#mTool").slideDown(),$("#mTool").draggable({containment:"#mapDiv"}),$("#measureOpen")):($("#mTool").slideUp(),$("#measureOpen"))}function togglePrint(){$("#printTool").is(":hidden")?($("#printTool").slideDown(),$("#printTool").draggable({containment:"#mapDiv"}),$("#printOpen")):($("#printTool").slideUp(),$("#printOpen"))}require(["dojo/dom-construct","dojo/dom","dojo/on","dojo/parser","dojo/query","dojo/keys","esri/sniff","esri/map","esri/SnappingManager","esri/dijit/Measurement","esri/dijit/Scalebar","esri/dijit/HomeButton","esri/dijit/LocateButton","esri/dijit/Geocoder","esri/InfoTemplate","esri/graphic","esri/geometry/Multipoint","esri/symbols/PictureMarkerSymbol","esri/symbols/SimpleFillSymbol","esri/symbols/SimpleLineSymbol","esri/tasks/IdentifyTask","esri/tasks/IdentifyParameters","esri/dijit/Popup","dojo/_base/array","dojo/_base/Color","esri/layers/ArcGISDynamicMapServiceLayer","esri/dijit/Legend","dijit/form/CheckBox","dijit/form/HorizontalSlider","dijit/form/HorizontalRule","dijit/form/HorizontalRuleLabels","js/vendor/bootstrapmap.min.js","esri/dijit/BasemapToggle","esri/layers/FeatureLayer","esri/dijit/PopupTemplate","esri/InfoTemplate","esri/symbols/SimpleMarkerSymbol","esri/dijit/Print","esri/tasks/PrintTemplate","esri/request","esri/config","dojo/domReady!"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,o,J,K,L,M){function N(a){var c,d,e;return c=x.filter(a.parameters,function(a){return"Layout_Template"===a.name}),0===c.length?void console.log('print service parameters name for templates must be "Layout_Template"'):(d=c[0].choiceList,mapOnlyRemove=x.indexOf(d,"MAP_ONLY"),mapOnlyRemove>-1&&d.splice(mapOnlyRemove,mapOnlyRemove),e=x.map(d,function(a){var b=new L;return b.layout=b.label=a,b.format="PDF",b.layoutOptions={titleText:"Wickenburg Zoning"},b}),printer=new K({map:db,templates:e,url:appConfig.printUrl},b.byId("printButton")),void printer.startup())}function O(a){console.log("Something broke: ",a)}function P(){var a=this.dojoAttachPoint,b=zb[a].checked;b===!0&&eb.remove(),b!==!0&&(eb=db.on("click",X))}function Q(a){var b=a.graphic?a.graphic:a.result.feature;b.setSymbol(Bb),S(a.result,b.symbol)}function R(a){if(a=a.results,a.length>0){U();for(var b=Bb,c=0;c<a.length;c++)S(a[c],b);T(a)}else alert("Sorry, address or place not found.")}function S(a,b){var c,d,e,f,g={};e=a.feature.geometry,g.address=a.name,g.score=a.feature.attributes.Score,c={address:g.address,score:g.score,lat:e.getLatitude().toFixed(2),lon:e.getLongitude().toFixed(2)},d=new o("${address}","Latitude: ${lat}<br/>Longitude: ${lon}<br/>Score: ${score}"),f=new p(e,b,c,d),db.graphics.add(f)}function T(a){for(var b=new q(db.spatialReference),c=0;c<a.length;c++)b.addPoint(a[c].feature.geometry);db.setExtent(b.getExtent().expand(2))}function U(){db.infoWindow.hide(),db.graphics.clear()}function V(a,b,c){return new r({angle:0,xoffset:b,yoffset:c,type:"esriPMS",url:a,contentType:"image/png",width:12,height:24})}function W(){identifyTask1=new u(kb),identifyTask2=new u(ob),identifyTask3=new u(mb),Y=new v,Y.tolerance=3,Y.returnGeometry=!0,Y.layerIds=[0],Y.layerOption=v.LAYER_OPTION_VISIBLE,Y.width=db.width,Y.height=db.height}function X(a){Y.geometry=a.mapPoint,Y.mapExtent=db.extent;var b=identifyTask1.execute(Y).addCallback(function(a){return x.map(a,function(a){var b=a.feature;if(b.attributes.layerName=a.layerName,0!==b.attributes.OBJECTID){var c=new o;c.setTitle("Wickenburg Zoning"),c.setContent("Zoning Code: ${CODE}<br>Zoning Description: ${Description}"),b.setInfoTemplate(c)}return b})}),c=identifyTask2.execute(Y).addCallback(function(a){return x.map(a,function(a){var b=a.feature;if(b.attributes.layerName=a.layerName,0!==b.attributes.OBJECTID){var c=new o;c.setTitle("County Parcels"),c.setContent("County: ${COUNTY}<br>Parcel: ${PARCEL_LABEL}<br>Address: ${PHYSICAL_ADDRESS}"),b.setInfoTemplate(c)}return b})}),d=identifyTask3.execute(Y).addCallback(function(a){return x.map(a,function(a){var b=a.feature;if(b.attributes.layerName=a.layerName,0!==b.attributes.OBJECTID){var c=new o;c.setTitle("Flood Zone"),c.setContent("Flood Zone: ${ZONE}"),b.setInfoTemplate(c)}return b})});db.infoWindow.setFeatures([b,c,d]),db.infoWindow.show(a.mapPoint)}d.parse(),esri.config.defaults.io.proxyUrl="proxy/proxy.ashx",esri.config.defaults.io.alwaysUseProxy=!1,b.byId("version").innerHTML=appConfig.Version;var Y,Z=[],$=[],_=new s(s.STYLE_SOLID,new t(t.STYLE_SOLID,new y([0,128,255]),3),null),ab=new s(s.STYLE_BACKWARD_DIAGONAL,new t(t.STYLE_SOLID,new y([0,255,255]),2),new y([0,255,255,.25])),bb=new J("circle",26,null,new y([0,0,0,.25])),cb=new w({fillSymbol:ab,markerSymbol:bb},a.create("div")),db=F.create("mapDiv",{extent:new esri.geometry.Extent(appConfig.initExtent),lods:appConfig.lods,basemap:"streets",showAttribution:!1,logo:!1,infoWindow:cb,sliderPosition:"top-right",scrollWheelZoom:!0});db.on("load",W);var eb=db.on("click",X);db.on("unload",X);var fb=(new k({map:db,scalebarUnit:"english"}),new l({map:db,visible:!0},a.create("div",{id:"HomeButton"},"mapDiv","last")));fb._homeNode.title="Original Extent",fb.startup();var gb=new m({map:db,visible:!0},a.create("div",{id:"LocateButton"},"mapDiv","last"));gb.startup();var hb=new G({map:db,visible:!0,basemap:"satellite"},a.create("div",{id:"BasemapToggle"},"mapDiv","last"));hb.startup();var ib=new n({value:"",zoomScale:10,maxLocations:10,autoComplete:!0,arcgisGeocoder:{sourceCountry:"USA",placeholder:"155 N Tegner St, Wickenburg, AZ"},map:db},"geosearch");ib.startup(),ib.on("select",Q),ib.on("findResults",R),ib.on("clear",U);var jb=M({url:appConfig.printUrl,content:{f:"json"}});jb.then(N,O);var kb=appConfig.wiZoningURL,lb=db.addLayer(new z(kb,{id:"wiZoning",visible:!0,opacity:".65"})),mb=appConfig.wiFloodURL,nb=db.addLayer(new z(mb,{id:"wiFlood",visible:!1,opacity:".65"})),ob=appConfig.tParcelsURL,pb=db.addLayer(new z(ob,{id:"tParcels",visible:!1,opacity:"1"})),qb=appConfig.coBoundaryURL,rb=db.addLayer(new z(qb,{id:"coBoundary",visible:!0,opacity:"1"})),sb=appConfig.wiBoundaryURL,tb=db.addLayer(new z(sb,{id:"wiBoundary",visible:!0,opacity:"1"})),ub=new o;ub.setTitle("${EMPNAME}"),ub.setContent("${ADDRESS}</br>${CITY}, ${STATE} ${ZIP}</br>Type:  ${CLUSTER}");var vb=appConfig.wiEmployerURL,wb=db.addLayer(new H(vb,{id:"Wickenburg Employers",visible:!1,opacity:"1",mode:H.MODE_ONDEMAND,infoTemplate:ub,outFields:["*"]})),xb=db.enableSnapping({snapKey:g("mac")?f.META:f.CTRL}),yb=[{layer:pb}];xb.setLayerInfos(yb);var zb=new j({map:db,lineSymbol:_},b.byId("measurementDiv"));zb.startup(),c(zb.area,"click",P),c(zb.distance,"click",P),c(zb.location,"click",P),Z.push({layer:pb,title:"Wickenburg Parcels"}),Z.push({layer:tb,title:"Wickenburg Boundary"}),Z.push({layer:nb,title:"Wickenburg Flood Zone"}),Z.push({layer:lb,title:"Wickenburg Zoning"}),Z.push({layer:wb,title:"Wickenburg Employers, 5+ employees"}),$.push({layer:pb,title:"Wickenburg Parcels"}),$.push({layer:rb,title:"Maricopa County Boundary"}),$.push({layer:tb,title:"Wickenburg Town Boundary"}),$.push({layer:nb,title:"Wickenburg Flood Zone"}),$.push({layer:lb,title:"Wickenburg Zoning"});var Ab=new A({map:db,layerInfos:$},"legendDiv");Ab.startup(),x.forEach(Z,function(c){var d=c.title,e=new B({name:"checkBox"+c.layer.id,value:c.layer.id,checked:c.layer.visible,onChange:function(){var a=db.getLayer(this.value);a.setVisibility(!a.visible),this.checked=a.visible}});a.place(e.domNode,b.byId("toggleDiv"));var f=a.create("label",{"for":e.name,innerHTML:"&nbsp;&nbsp;"+d},e.domNode,"after");a.place("<br>",f,"after")});var Bb=(new C({name:"slider1",value:nb.opacity,minimum:0,maximum:1,intermediateChanges:!0,discreteValues:11,style:"width:250px;",onChange:function(a){nb.setOpacity(a)}},"slider1"),new C({name:"slider2",value:lb.opacity,minimum:0,maximum:1,intermediateChanges:!0,discreteValues:11,style:"width:250px;",onChange:function(a){lb.setOpacity(a)}},"slider2"),V("img/blue-pin.png",0,12,35)),Cb=a.create("a",{"class":"action",id:"infoLink",innerHTML:"Assessor Info",href:"javascript: void(0);"},e(".actionList",db.infoWindow.domNode)[0]);c(Cb,"click",function(){var a=db.infoWindow.getSelectedFeature(),b=(window.location,"");"13"===a.attributes.COUNTY_FIPS&&(b=appConfig.MaricopaAssessor+a.attributes.PARCEL,window.open(b)),"25"===a.attributes.COUNTY_FIPS&&(b=appConfig.YavapaiAssessor+a.attributes.PARCEL,window.open(b))})}),$(document).ready(function(){$("#contentsOpen").fadeTo("slow"),$("#legend").fadeTo("slow"),contentsOpen=$("#contentsOpen").height(),$("#legend").css("top",contentsOpen),$("#contentsOpen").click(function(){toggleContent()})}),$(document).ready(function(){$("#measureOpen").fadeTo("slow"),$("#mTool").fadeTo("slow"),measureOpen=$("#measureOpen").height(),$("#mTool").css("top",measureOpen),$("#measureOpen").click(function(){toggleMTool()})}),$(document).ready(function(){$("#mTool").hide()}),$(document).ready(function(){$("#printOpen").fadeTo("slow"),$("#printTool").fadeTo("slow"),printOpen=$("#printOpen").height(),$("#printTool").css("top",printOpen),$("#printOpen").click(function(){togglePrint()})}),$(document).ready(function(){$("#printTool").hide()}),$(document).ready(function(){$("#legend").load("views/contents.html"),$("#helpContent").load("views/helpContent.html"),$("#aboutInfo").load("views/about.html"),$("#legalDisclaimer").load("views/legalDisclaimer.html"),$("#definitions").load("views/definitions.html"),$("#mTool").load("views/measureTool.html"),$("#helpTool").load("views/helpTool.html"),$("#printTool").load("views/printTool.html"),$("#helpPrint").load("views/helpPrint.html")});