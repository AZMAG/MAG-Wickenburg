/*! ========================================================================
 * Maricopa Association of Governments
 * JavaScript files for MAG Wickenburg Zoning Map Viewer
 * @main.min.js | version | 3.7.7
 * Production | 09/16/2016
 * http://geo.azmag.gov/maps/wickenburg/
 * MAG Wickenburg Zoning Map Viewer
 * ==========================================================================
 * Copyright 2016 MAG
 * Licensed under MIT
 * ========================================================================== */

define(["esri/map","esri/dijit/Popup","esri/arcgis/utils","dojo/_base/declare","dojo/on","dojo/dom","dojo/_base/lang","dojo/dom-style","dojo/query","dojo/NodeList-traverse","dojo/domReady!"],function(a,b,c,d,e,f,g,h,i,j){"use strict";return{create:function(a,b){if(a&&b){var c=new this._smartResizer(a,b),d=c.createMap();return d._smartResizer=c,d}},createWebMap:function(a,b,c){if(b&&c){var d=new this._smartResizer(b,c),e=d.createWebMap(a);return e}},bindTo:function(a){if(a){var b=new this._smartResizer(a.id,a._params),c=b.bindToMap(a);return c._smartResizer=b,c}},destroy:function(a){function b(a){if(a._handles)for(var b=a._handles.length;b--;)a._handles[b].remove(),a._handles.splice(b,1)}a&&a._smartResizer&&b(a._smartResizer)},_smartResizer:d(null,{_mapDivId:null,_mapDiv:null,_mapStyle:null,_map:null,_delay:50,_windowH:0,_windowW:0,_visible:!0,_visibilityTimer:null,_mapDeferred:null,constructor:function(a,b){this._mapDivId=a,this._mapDiv=f.byId(a),this._mapStyle=h.get(this._mapDiv),this._options=g.mixin(b,{}),this._handles=[]},createMap:function(){return this._setMapDiv(!1),g.mixin(this._options,{smartNavigation:!1,autoResize:!1}),this._map=new a(this._mapDivId,this._options),this._bindEvents(),this._mapDiv.__map=this._map,this._map},createWebMap:function(a){this._setMapDiv(!1),this._options.hasOwnProperty("mapOptions")||(this._options.mapOptions={}),g.mixin(this._options.mapOptions,{smartNavigation:!1,autoResize:!1});var b=c.createMap(a,this._mapDivId,this._options);this._mapDeferred=b;var d=this,e=function(a){this._map=a.map,this._bindEvents(),this._mapDiv.__map=this._map,this._smartResizer=d};return this._mapDeferred.then(g.hitch(this,e)),b},bindToMap:function(a){return this._setMapDiv(!0),this._map=a,this._setMapDiv(!0),this._bindEvents(),this._setTouchBehavior(),this._mapDiv.__map=this._map,this._map},_setTouchBehavior:function(){this._options.hasOwnProperty("scrollWheelZoom")&&this._options.scrollWheelZoom?this._map.enableScrollWheelZoom():this._map.disableScrollWheelZoom()},_bindEvents:function(){if(!this._map)return void console.log("BootstrapMap: Invalid map object. Please check map reference.");var a=function(a){this._setTouchBehavior()};this._handles.push(e(this._map,"load",g.hitch(this,a)));var b=function(a){this._map.infoWindow.anchor="top";var b=function(a){var b=a._map.infoWindow.getSelectedFeature();if(b){var c;c="point"==b.geometry.type?b.geometry:b.geometry.getExtent().getCenter(),window.setTimeout(function(){a._repositionInfoWin(c)},250)}};e(this._map.graphics,"click",g.hitch(this,function(a){b(this)})),e(this._map.infoWindow,"selection-change",g.hitch(this,function(a){b(this)}))};this._handles.push(e(this._map,"load",g.hitch(this,b))),this._map.loaded&&g.hitch(this,b).call();var c=function(a,b,c){var d;return function(){function e(){c||a.apply(f,g),d=null}var f=this,g=arguments;d?clearTimeout(d):c&&a.apply(f,g),d=setTimeout(e,b||100)}},d=c(this._setMapDiv,100,!1);this._handles.push(e(window,"resize",g.hitch(this,d)));var f=function(a,b,c){this._map.__resizeCenter=this._map.extent.getCenter();var d=function(){this._map.infoWindow.isShowing&&this._repositionInfoWin(this._map.infoWindow.features[0]),this._map.centerAt(this._map.__resizeCenter)};setTimeout(g.hitch(this,d),this._delay)};this._handles.push(e(this._map,"resize",g.hitch(this,f)))},_checkVisibility:function(){var a=this._getMapDivVisibility();this._visible!==a&&a&&this._setMapDiv(!0)},_getMapDivVisibility:function(){return $("#"+this._mapDivId).is(":visible")},_controlVisibilityTimer:function(a){a?this._visibilityTimer=setInterval(function(){this._checkVisibility()}.bind(this),200):this._visibilityTimer&&(clearInterval(this._visibilityTimer),this._visibilityTimer=null)},_setMapDiv:function(a){if(this._mapDivId){var b=this._getMapDivVisibility();this._visible!==b&&(this._visible=b,this._controlVisibilityTimer(!b));var c=window.innerHeight,d=window.innerWidth;if(c!=this._windowH||d!=this._windowW){this._windowH=c,this._windowW=d;var e=document.body.clientHeight,f=c-e,g=this._calcMapHeight(),i=this._calcColumnHeight(g),j=g+f,k=0,l=!1;i>g?(k=f>0?i+f:i,l=!0):(k=i>j?i:j,l=!1),h.set(this._mapDivId,{height:k+"px",width:"100%"}),this._map&&a&&this._visible&&(this._map.resize(),this._map.reposition())}}},_calcMapHeight:function(a){var b=this._mapStyle,c=parseInt(b.paddingTop)+parseInt(b.paddingBottom),d=parseInt(b.marginTop)+parseInt(b.marginBottom),e=parseInt(b.borderTopWidth)+parseInt(b.borderBottomWidth),f=c+d+e+this._mapDiv.clientHeight;return f},_calcColumnHeight:function(a){var b=0,c=i(this._mapDiv).closest(".row").children("[class*='col']");if(c.length)for(var d=0;d<c.length;d++){var e=c[d],f=i("#"+this._mapDivId,e).length>0;e.clientHeight>b&&!f&&(b=e.clientHeight)}return b},_repositionInfoWin:function(a){var b=new esri.geometry.Point(this._map.extent.xmax,this._map.extent.ymax,this._map.spatialReference),c=new esri.geometry.Point(this._map.extent.getCenter()),d=this._map.toScreen(b),e=this._map.toScreen(c),f=this._map.toScreen(a),g=10,h=3,i=this._map.infoWindow.domNode.childNodes[0],j=i.clientWidth,k=i.clientHeight+this._map.infoWindow.marginTop,l=f.x-j/2,m=f.x+j/2,n=0>l-g,o=m>d.x-g;n?e.x-=Math.abs(l)+g<g?g:Math.abs(l)+g:o&&(e.x+=m-d.x+g);var p=this._map.infoWindow.offsetY,q=f.y-k-p,r=0>q-h;r&&(e.y+=q-h),(o||n||r)&&(c=this._map.toMap(e),this._map.centerAt(c))}})}});